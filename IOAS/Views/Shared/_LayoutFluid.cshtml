@using IOAS.Infrastructure
<!DOCTYPE html>
<html>
<head>
    <title>@ViewBag.Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="@Url.Content("~/Content/IOASContent/img/tula-logo.png")" type="image/x-icon"> 
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,700" rel="stylesheet">
    <link href="@Url.Content("~/Content/IOASContent/css/ionicons.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/css/bootstrap.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/css/bootstrap-theme.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/css/custom-css.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/css/Developercss/Style.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/Base/jquery-ui.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/Base/jquery.ui.datepicker.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/css/jquery-confirm.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/Base/jquery.ui.datepicker.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/IOASContent/assets/bootstrap-select/css/bootstrap-select.min.css")" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    @Styles.Render("~/bundles/JSGridCss")

    <script src="@Url.Content("~/Content/IOASContent/assets/js/plugins/jquery-2.2.4.min.js")"></script>
    @*<script src="@Url.Content("~/Content/IOASContent/js/JSGrid/jsgrid.min.js")"></script>
        <link href="@Url.Content("~/Content/IOASContent/js/jsgrid-1.5.3/jsgrid-theme.min.css")" rel="stylesheet" />
        <link href="@Url.Content("~/Content/IOASContent/js/jsgrid-1.5.3/jsgrid.min.css")" rel="stylesheet" />
        <script src="@Url.Content("~/Content/IOASContent/js/jsgrid-1.5.3/jsgrid.min.js")"></script>*@
    <script src="@Url.Content("~/Content/IOASContent/Base/jquery-ui.js")"></script>
    <script src="@Url.Content("~/Content/IOASContent/js/bootstrap.min.js")"></script>
    <script src="@Url.Content("~/Scripts/site.js")"></script>
    <script src="@Url.Content("~/Content/IOASContent/assets/bootstrap-select/js/bootstrap-select.min.js")"></script>
    <script src="@Url.Content("~/Content/IOASContent/js/moment.min.js")"></script>
    <script src="@Url.Content("~/Content/IOASContent/js/jquery-confirm.min.js")"></script>
    <script src="@Url.Content("~/Scripts/Common.js")"></script>
    <script src="@Url.Content("~/Scripts/ckeditor/ckeditor.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/ckeditor/adapters/jquery.js")" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    @Scripts.Render("~/bundles/JSGrid")
    @*<script type="text/javascript">
            jQuery.noConflict();
        </script>*@
</head>

<body>
    <!-- /.Video modal -->
    <!-- js files -->
    <!-- all plugins minified js -->
    <div class="loading-bg dis-none">
        <div class="sk-cube-grid vr-algn">
            <div class="sk-cube sk-cube1"></div>
            <div class="sk-cube sk-cube2"></div>
            <div class="sk-cube sk-cube3"></div>
            <div class="sk-cube sk-cube4"></div>
            <div class="sk-cube sk-cube5"></div>
            <div class="sk-cube sk-cube6"></div>
            <div class="sk-cube sk-cube7"></div>
            <div class="sk-cube sk-cube8"></div>
            <div class="sk-cube sk-cube9"></div>
        </div>
    </div>
    <div class="wrapper">
        <div class="main-content">
            @if (Request.IsAuthenticated)
            {

                if (User.Identity.Name != "")
                {
                    var username = User.Identity.Name;
                    var UserId = Common.GetUserid(username);
                    var menulist = Common.Getaccessrole(UserId);
                    @Html.Partial("_SidebarPartial", menulist)
                }
            }
            <div class="rgt-cnt lg-sd-hgt">


                @Html.Partial("_LoginPartial")


                @RenderBody()
                <div id="divTapalView"></div>
            </div>

        </div>

    </div>

    <div id="Validation" class="modal fade modal-warning" role="dialog">
        <div class="modal-dialog modal-sm">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <i class="ion-android-warning"></i>
                    <h3 class="modal-title">Warning</h3>
                </div>
                <div class="modal-body">

                    <p id="alert"></p>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>
    <div id="Success" class="modal fade modal-success" role="dialog">
        <div class="modal-dialog modal-sm">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <i class="ion-android-checkmark-circle"></i>
                    <h3 class="modal-title">Saved successfully</h3>
                </div>
                <div class="modal-body">

                    <p id="alertSuccess"></p>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>
    <div id="Failed" class="modal fade modal-error" role="dialog">
        <div class="modal-dialog modal-sm">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <i class="ion-android-cancel"></i>
                    <h3 class="modal-title">Error Message</h3>
                </div>
                <div class="modal-body">

                    <p id="FailedAlert"></p>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            function setHeight() {
                windowHeight = $(window).innerHeight();
                $('.lg-sd-hgt').css('min-height', windowHeight);
            };
            setHeight();

            $(window).resize(function () {
                setHeight();
            });

            //8917 - Browser tab restriction.
            var maxTabs = 4;
            // Get the current tab count from sessionStorage, or set it to zero
            var tabCount = sessionStorage.getItem('tabCount') || 0;

            // Increment the tab count and store it in sessionStorage
            tabCount++;
            sessionStorage.setItem('tabCount', tabCount);

            // If the tab count exceeds the maximum, close the current tab
            tabCount = parseInt(tabCount);
            console.log("tabcount:" + tabCount);
            
            /*Assign Localstorage on each  tab occurence for the 1st time*/
            if (tabCount == 4) {
                localStorage.setItem('openPage4', Date.now());
            }
            if (tabCount == 3) {
                localStorage.setItem('openPage3', Date.now());
            }

            if (tabCount == 2) {
                localStorage.setItem('open2', Date.now());
            }

            if (tabCount == 1) {
                document.title = "Root-Dashboard";
                localStorage.setItem('open1', Date.now());
            }

            /**
             * Declare storage event for each tab
             * 
             */
            var onLocalStorageEvent1 = function (e) {

                if (e.key == "open1") {
                    window.localStorage.setItem('pageAlreadyOpen1', Date.now());
                }
                if (e.key == "pageAlreadyOpen1") {
                    alert("The tabs are restricted.Kindly close the tabs which are unused.");
                    window.location.href = "https://tularpt.icsr.in/TulaTabs.html";
                    return false;
                }
            };
            var onLocalStorageEvent2 = function (e) {

                if (e.key == "open2") {
                    window.localStorage.setItem('pageAlreadyOpen2', Date.now());
                }
                if (e.key == "pageAlreadyOpen2") {
                    alert("The tabs are restricted.Kindly close the tabs which are unused.");
                    window.location.href = "https://tularpt.icsr.in/TulaTabs.html";
                    return false;
                }
            };
            var onLocalStorageEvent3 = function (e) {

                if (e.key == "openPage4") {
                    window.localStorage.setItem('pageAlreadyOpen4', Date.now());
                }
                if (e.key == "pageAlreadyOpen4") {
                    alert("The tabs are restricted.Kindly close the tabs which are unused.");
                    window.location.href = "https://tularpt.icsr.in/TulaTabs.html";
                    return false;
                }
            };
            var onLocalStorageEvent = function (e) {

                if (e.key == "openPage3") {
                    window.localStorage.setItem('pageAlreadyOpen3', Date.now());
                }
                if (e.key == "pageAlreadyOpen3") {
                    alert("The tabs are restricted.Kindly close the tabs which are unused.");
                    window.location.href = "https://tularpt.icsr.in/TulaTabs.html";
                    return false;
                }
            };
            /*Restrict each tabs second occurence*/
            if (tabCount == 4) {
                var localStoragedate4 = window.localStorage.getItem('openPage4');
                console.log("localStorageDate4:" + localStoragedate3);
                var localStoragedate5 = window.localStorage.getItem('page1');

                console.log("localStorageDate5:" + localStoragedate5);
                if (localStoragedate4 != localStoragedate5) {
                    window.addEventListener('storage', onLocalStorageEvent3, false);
                }
            }

            if (tabCount == 3) {
                var localStoragedate3 = window.localStorage.getItem('openPage3');
                console.log("localStorageDate3:" + localStoragedate3);
                var localStoragedate4 = window.localStorage.getItem('page1');

                console.log("localStorageDate4:" + localStoragedate4);
                if (localStoragedate3 != localStoragedate4) {
                    window.addEventListener('storage', onLocalStorageEvent, false);
                }
            }

            if (tabCount > maxTabs) {
                window.location.href = "https://tularpt.icsr.in/TulaTabs.html";
                return false;
            }

            if (tabCount == 2) {
                var localStoragePage2 = localStorage.getItem('open2');
                console.log('sessionPage2 :' + localStoragePage2);
                var localStoragedate3 = localStorage.getItem('openPage3');
                console.log("localStorageDate3:" + localStoragedate3);
                if (localStoragedate3 != localStoragePage2) {
                    window.addEventListener('storage', onLocalStorageEvent2, false);
                }               
            }
            if (tabCount == 1) {
                var localStoragePage1 = localStorage.getItem('open1');
                console.log('sessionPage2 :' + localStoragePage1);
                
                var localStoragedate2 = window.localStorage.getItem('open2');
                console.log('localStoragedate2:' + localStoragedate2);
                if (localStoragePage1 != localStoragedate2) {
                    //tabCount = tabCount - 1;
                    window.addEventListener('storage', onLocalStorageEvent1, false);
                }
            }
            
            $(window).on('beforeunload', function () {
                // Decrement the tab count and update sessionStorage when the tab is closed
                var tabCount = sessionStorage.getItem('tabCount') || 0;
                tabCount--;
                if (parseInt(tabCount) != 0)
                    sessionStorage.setItem('tabCount', tabCount);
            });
            loadTapalView();
        });

        $('form').on('submit',function () {
            var id = $(this).attr('Id');
            if (id != "frmPaymentInit" && id != "frmCommitment" && id != "frmSalaryPayment" && id != "frmSalaryPayment") {
                $(this).find('button[type="submit"],#nextBtn,#btnSave,#btnValidate').attr('disabled', 'disabled');
                $(this).find('input[type="submit"]').attr('readonly', true);
                //$('button[type="submit"],input[type="submit"],#nextBtn,#btnSave,#btnValidate').attr('disabled', 'true');
            }
        });

        $('#ReferenceNumber,#Source').blur(function () {
            loadTapalView();
        });
        function loadTapalView() {
            var selSource = $('#Source').val();
            var tplId = $('#SourceReferenceNumber').val() || 0;
            $("#divTapalView").html('');
            if (selSource == '3' && tplId > 0) {
                var searchData = { "TapalId": tplId };
                $.ajax({
                    url: "@Url.Action("_TapalDetails", "Facility")",
                    type: "GET",
                data: searchData,
                contentType: "application/x-www-form-urlencoded",
                success: function (data) {
                    $("#divTapalView").html(data);
                },
                error: function (err) {
                    console.log("error : " + err);
                }
            });
        }
        }
    </script>

</body>
</html>
