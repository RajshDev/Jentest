@model  IOAS.Models.OutSourcingDocumentUpload
@{
    ViewBag.Title = "OSGUploadDocument";
    Layout = "~/Views/Shared/_LayoutFluid.cshtml";
}

<div class="row hd-tt-bg">
    <div class="col-md-12">
        <h4><b>OSG Upload Document</b></h4>
    </div>
</div>
<div class="row cts-mn-dts">
    <div class="page-wrapper mt30">
        <div>
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-12">
                        <div class="bl-lg-panel-box pb-null">
                            <div class="cmn-panel-box">
                                <div class="row">
                                   <div class="col-md-4">
                                       <div class="form-group custom-form-group">
                                           <label class="required">Employee Id</label>
                                           @Html.TextBoxFor(m => m.EmployeeNo, new { @class = "form-control" })
                                           @Html.TextBoxFor(m => m.OSGid, new { @class = "form-control dis-none" })
                                           <div>@Html.ValidationMessageFor(m => m.EmployeeNo)</div>
                                       </div>
                                       </div>
                                    <div class="col-md-4">
                                        <div class="form-group custom-form-group">
                                            <label class="required">Appointment Type</label>
                                            @Html.DropDownListFor(m => m.AppointmentType, new SelectList(ViewBag.type, "id", "name"), "Select", new { @class = "form-control",@onchange= "Attachementload();" })
                                            <div>@Html.ValidationMessageFor(m => m.AppointmentType)</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt30">
                                    <div class="col-md-12">

                                        <table class="table" id="tblAttachment">
                                            <thead>
                                                <tr>
                                                    <td colspan="2"><label id="lblheadeing"></label></td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Attachment type</th>
                                                    <th scope="col">Attachment</th>
                                                 </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>   

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12 mb-lg text-center">
        <input type="submit" class="btn btn-primary" value="Submit" name="Button" id="btnDocment" />
        <input type="button" onclick="window.location.href='@Url.Action("Dashboard", "Home")';" class="btn btn-default" value="Close" id="btnclose" />
    </div>
</div>
<script>
    applyAutoComplete($('#EmployeeNo'), $('#OSGid'), '@Url.Action("LoadOSGEmployeeList", "Requirement")', 'LoadAppointmentType', true);

    function LoadAppointmentType()
    {
        
        var OSGid = $('#OSGid').val() || null;
        if (OSGid != null) {
            $("#AppointmentType").empty().append($('<option/>', { value: "", text: "Select Appointment" }));
            $.getJSON("@Url.Action("Loaddocbaseappointment", "Requirement")", { id: OSGid },
                        function (locationdata) {
                            debugger;
                            $.each(locationdata, function (index, itemData) {
                                $("#AppointmentType").append($('<option/>', {
                                    value: itemData.id,
                                    text: itemData.name
                                }));
                            });
                        });
        }
    }

    function Attachementload()
    {
        
        var idval = $("#AppointmentType").val()||null;
        var idtext = $("#AppointmentType option:selected").text()||null;
        if (idval != null && idtext !=null)
        {
           
            $.ajax({
                type: "Post",
                url: '@Url.Action("FillDocumentlist", "Requirement")',
                data: { "id": idval,"appointmentname": idtext },
                dataType: "json",
                success: function (jsonData) {
                    $("#lblheadeing").text(idtext);
                    $("#tblAttachment tbody").html("");
                    $("#tblAttachment tbody").append();
                    for (var i = 0; i < jsonData.result.length; i++) {
                        
                        var index = i+1;
                        {
                            var table = '<tr>' + '<td id="docId_' + index + '" style="display:none">' + jsonData.result[i].DocumentId + '</td>' +
                                                 '<td id="docType_' + index + '">' + jsonData.result[i].DocumentType + '</td>' +
                                                 '<td><input type="file"  id="docment_' + index + '" name=DocumentDetail[' + index + '].Document></td>' + '</tr>'
                            $("#tblAttachment tbody").append(table);
                        }
                    }
                }
            });
        }
    }
    $("#btnDocment").on('click', function () {
       
            var inputdetail = [];
            var inputheader = [];
            var table = $("#tblAttachment tbody");
            var osgid = $('#OSGid').val()||null;
            var appid = $('#AppointmentType').val()||null;
            var apptypename = $("#AppointmentType option:selected").text() || null;
            if (osgid == null)
            {
                $.confirm({
                    title: 'Warning!',
                    content: 'Please Enter Employee id',
                    type: 'orange',
                    buttons: {
                        Ok: function () {
                            //close
                        },
                    },
                });
                return false;
            }
            if (appid == null) {
                $.confirm({
                    title: 'Warning!',
                    content: 'Please Select Appointment Type',
                    type: 'orange',
                    buttons: {
                        Ok: function () {
                            //close
                        },
                    },
                });
                return false;
            }
            //var fileValid = ValidationFile();
            //if (fileValid) {
            //    $.confirm({
            //        title: 'Warning!',
            //        content: 'Please Choose All Files',
            //        type: 'orange',
            //        buttons: {
            //            Ok: function () {
            //                //close
            //            },
            //        },
            //    });
            //    return false;
            //}
            table.find('tr').each(function (e) {
                var docid = $(this).find("td:eq(0)").text();
                var docname = $(this).find("td:eq(1)").text();
                var document = $(this).find('input[name$=".Document"]').get(0);
                
                inputdetail.push({
                    DocumentId: docid,
                    DocumentType: docname,
                    Document: document.files[0],
                    
                });
            });
            
            var data = new FormData();
            for (var x = 0; x < inputdetail.length; x++) {
                data.append("DocumentDetail["+x+"].DocumentId", inputdetail[x].DocumentId);
                data.append("DocumentDetail[" + x + "].DocumentType", inputdetail[x].DocumentType);
                data.append("DocumentDetail[" + x + "].Document", inputdetail[x].Document);
            }
            data.append("OSGid", osgid);
            data.append("AppointmentTypeName", apptypename);
            $.ajax({
                type: "POST",
                url: '@Url.Action("OSGDocumentadd", "Requirement")',
                contentType: false,
                processData: false,
                dataType: 'json',
                data: data,
                cache: false,
                beforeSend: function () {
                    $(".loading-bg").removeClass('dis-none');
                },
                success: function (result) {
                    $(".loading-bg").addClass('dis-none');
                    if (result == 1)
                    {
                        $.confirm({
                            title: 'Success!',
                            content: 'Add Document Sucessfully',
                            type: 'green',
                            buttons: {
                                Ok: function () {
                                    location.reload();
                                },
                            },
                        });
                    }
                }
            });
      
    
    });
    $(document).on('change', 'input[name$=".Document"]', function () {
        var file = $(this).val();
        if (file != "") {
            var file_size = $(this)[0].files[0].size;
            var extension = file.substr((file.lastIndexOf('.') + 1)).toLowerCase();
            switch (extension) {
                case 'pdf':
                    isValidExten = true;
                    break;
                default:
                    isValidExten = false;
            }
            if (isValidExten == false) {
                $('#alert').html("Please upload any one of these type file [pdf].");
                $('#Validation').modal('toggle');
                $(this).val('');
                return false;
            }
            else if (file_size > 5242880) {
                $('#alert').html("You can upload the file up to 5 MB.");
                $('#Validation').modal('toggle');
                $(this).val('');
                return false;
            }
        }
    });

    //function ValidationFile()
    //{
    //    var hasErr = false;
    //    var cln = $("#tblAttachment tbody");
    //    $(cln).find('input[name $=".Document"]').each(function () {
    //        var value = $(this).val() || "";
    //        if (value == "")
    //            hasErr = true;
    //    });
    //    return hasErr;
    //}
</script>
 <script src="@Url.Content("~/Content/IOASContent/assets/bootstrap-select/js/bootstrap-select.min.js")"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/FoolProof/mvcfoolproof.unobtrusive.min.js")" type="text/javascript"></script>
