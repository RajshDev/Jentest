@model IOAS.Models.ProjectExpReportSPprocessModel
@{
    ViewBag.Title = "Project Expenditure Report";
    ViewBag.Subtitle = "Project Expenditure";
    Layout = "~/Views/Shared/_LayoutFluid.cshtml";
}
@using (Html.BeginForm("ProjectExpReport", "ReportMaster", FormMethod.Post, new { @class = "", role = "form", @id = "formPP", enctype = "multipart/form-data" }))
{
    <div class="row hd-tt-bg">
        <div class="col-md-4">
            <h3>Project Expenditure Report</h3>
        </div>
    </div>
    <div class="row mt-20">
        <div class="col-md-12 col-sm-12 m-b-sm">
            <div class="page-wrapper mt-md">
                <div class="row mb-lg">
                    <div class="col-md-12 text-center">
                        @if (Model.status == "Completed" || String.IsNullOrEmpty(Model.status))
                        {
                            <a id="btnExecSP" class="btn btn-default" href="javascript:void(0)"> Start</a>
                            <a id="btnRefresh" class="btn btn-primary  dis-none" href="javascript:void(0)"> Refresh</a>
                        }
                        else
                        {
                            <a id="btnExecSP" class="btn btn-default dis-none" href="javascript:void(0)"> Start</a>
                            <a id="btnRefresh" class="btn btn-primary" href="javascript:void(0)"> Refresh</a>
                        }

                    </div>                   
                </div>    
                <div class="row">
                    <div class="col-md-3">
                        <label>Start Time</label> <br />
                        <span id="lblStart">@Model.startTime</span>
                    </div>
                    <div class="col-md-3">
                        <label>Competed Time</label> <br />
                        <span id="lblEnd">@Model.endTime</span>
                    </div>
                    <div class="col-md-3">
                        <label>Status</label> <br />
                        <span id="lblStatus">@Model.status</span>
                    </div>
                    <div class="col-md-3">
                        <a id="btnDownloadData" href="javascript:void(0)">Download</a>
                    </div>
                </div>          
            </div>
        </div>
    </div>
}
@Html.AntiForgeryToken()
<script type="text/javascript">

    $('#btnExecSP').click(function () {
        $('.loading-bg').removeClass('dis-none');
        var token = $("input[name=__RequestVerificationToken]").val();
        $.ajax({
            type: "POST",
            url: '@Url.Action("ExecuteProjectExpSP", "ReportMaster")',
            data: { "__RequestVerificationToken": token },
            contentType: "application/x-www-form-urlencoded",
            dataType: "json",
            success: function (result) {
                $('.loading-bg').addClass('dis-none');
                refreshResult();
            },
            error: function (err) {
                $('.loading-bg').addClass('dis-none');
                console.log("error : " + err);
            }
        });
    });
    function refreshResult() {
        $('.loading-bg').removeClass('dis-none');
        var token = $("input[name=__RequestVerificationToken]").val();
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetProjectExpSPStatus", "ReportMaster")',
            data: { "__RequestVerificationToken": token },
            contentType: "application/x-www-form-urlencoded",
            dataType: "json",
            success: function (result) {
                var status = result.status || "";
                if (status == "Completed" || status == "") {
                    $('#btnRefresh').addClass('dis-none');
                    $('#btnExecSP').removeClass('dis-none');
                } else {
                    $('#btnExecSP').addClass('dis-none');
                    $('#btnRefresh').removeClass('dis-none');
                }
                $('#lblStart').text(result.startTime);
                $('#lblEnd').text(result.endTime);
                $('#lblStatus').text(status);
                $('.loading-bg').addClass('dis-none');
            },
            error: function (err) {
                $('.loading-bg').addClass('dis-none');
                console.log("error : " + err);
            }
        });
    }
    $('#btnRefresh').click(function () {
        refreshResult();
    });
    $('#btnDownloadData').click(function () {        
        var url = '@Url.Action("ProjectExpSPReport", "Reports")';
        window.open(url, '_blank');
    });
</script>
<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/FoolProof/mvcfoolproof.unobtrusive.min.js")" type="text/javascript"></script>
